<?php

namespace Jiny\Admin\App\Http\Controllers\Admin;

use Jiny\Admin\App\Http\Controllers\AdminResourceController;
use Illuminate\Http\Request;
use Illuminate\Http\RedirectResponse;
use Illuminate\View\View;
use Jiny\Admin\App\Models\SystemMaintenanceLog;
use Jiny\Admin\App\Models\AdminUser;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;
use Illuminate\Support\Facades\File;

/**
 * AdminSystemMaintenanceLogController
 *
 * Í¥ÄÎ¶¨Ïûê ÏãúÏä§ÌÖú Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ Í¥ÄÎ¶¨ Ïª®Ìä∏Î°§Îü¨
 * AdminResourceControllerÎ•º ÏÉÅÏÜçÌïòÏó¨ ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Ìå®ÌÑ¥ÏúºÎ°ú Íµ¨ÌòÑ
 * 
 * ÏãúÏä§ÌÖú Ïú†ÏßÄÎ≥¥Ïàò ÏûëÏóÖÏùò Í≥ÑÌöç, Ïã§Ìñâ, ÏôÑÎ£å Í≥ºÏ†ïÏùÑ Ï∂îÏ†ÅÌïòÍ≥† Í∏∞Î°ù:
 * - Ïú†ÏßÄÎ≥¥Ïàò ÏùºÏ†ï Í¥ÄÎ¶¨ Î∞è ÏûëÏóÖ ÏßÑÌñâ ÏÉÅÌô© Î™®ÎãàÌÑ∞ÎßÅ
 * - Îã§Ïö¥ÌÉÄÏûÑ Í≥ÑÌöç Î∞è ÏòÅÌñ•ÎèÑ Î∂ÑÏÑù
 * - Ïú†ÏßÄÎ≥¥Ïàò ÏûëÏóÖ ÌÜµÍ≥Ñ Î∞è ÏÑ±Îä• ÏßÄÌëú Î∂ÑÏÑù
 *
 * @package Jiny\Admin\App\Http\Controllers\Admin
 * @author JinyPHP
 * @version 1.0.0
 * @since 1.0.0
 * @license MIT
 *
 * ÏÉÅÏÑ∏Ìïú Í∏∞Îä•ÏùÄ Í¥ÄÎ†® Î¨∏ÏÑúÎ•º Ï∞∏Ï°∞ÌïòÏÑ∏Ïöî.
 * @docs jiny/admin/docs/features/AdminSystemMaintenanceLog.md
 *
 * üîÑ Í∏∞Îä• ÏàòÏ†ï Ïãú ÌÖåÏä§Ìä∏ Ïã§Ìñâ ÌïÑÏöî:
 * Ïù¥ Ïª®Ìä∏Î°§Îü¨Ïùò Í∏∞Îä•Ïù¥ ÏàòÏ†ïÎêòÎ©¥ Îã§Ïùå ÌÖåÏä§Ìä∏Î•º Î∞òÎìúÏãú Ïã§ÌñâÌï¥Ï£ºÏÑ∏Ïöî:
 *
 * ```bash
 * # Ï†ÑÏ≤¥ Í¥ÄÎ¶¨Ïûê ÏãúÏä§ÌÖú Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ Í¥ÄÎ¶¨ ÌÖåÏä§Ìä∏ Ïã§Ìñâ
 * php artisan test jiny/admin/tests/Feature/Admin/AdminSystemMaintenanceLogTest.php
 * ```
 */
class AdminSystemMaintenanceLogController extends AdminResourceController
{
    // Î∑∞ Í≤ΩÎ°ú Î≥ÄÏàò Ï†ïÏùò
    public $indexPath = 'jiny-admin::admin.system_maintenance_logs.index';
    public $createPath = 'jiny-admin::admin.system_maintenance_logs.create';
    public $editPath = 'jiny-admin::admin.system_maintenance_logs.edit';
    public $showPath = 'jiny-admin::admin.system_maintenance_logs.show';

    // ÌïÑÌÑ∞ÎßÅ Î∞è Ï†ïÎ†¨ Í¥ÄÎ†® ÏÑ§Ï†ï
    protected $filterable = ['maintenance_type', 'status', 'priority', 'requires_downtime', 'search', 'start_date', 'end_date'];
    protected $validFilters = [
        'maintenance_type' => 'string|max:100',
        'status' => 'string|max:50',
        'priority' => 'string|max:50',
        'requires_downtime' => 'boolean',
        'search' => 'string',
        'start_date' => 'date',
        'end_date' => 'date'
    ];
    protected $sortableColumns = ['created_at', 'title', 'maintenance_type', 'status', 'priority', 'scheduled_start', 'actual_start', 'duration_minutes'];

    /**
     * Î°úÍπÖ ÌôúÏÑ±Ìôî
     */
    protected $activeLog = true;

    /**
     * Î°úÍ∑∏ ÌÖåÏù¥Î∏îÎ™Ö
     */
    protected $logTableName = 'system_maintenance_logs';

    /**
     * ÏÉùÏÑ±Ïûê
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * ÌÖåÏù¥Î∏î Ïù¥Î¶Ñ Î∞òÌôò
     * System Maintenance Log ÌÖåÏù¥Î∏î Ïù¥Î¶Ñ Î∞òÌôò
     */
    protected function getTableName()
    {
        return 'system_maintenance_logs';
    }

    /**
     * Î™®Îìà Ïù¥Î¶Ñ Î∞òÌôò
     * System Maintenance Log Î™®Îìà Ïù¥Î¶Ñ Î∞òÌôò
     */
    protected function getModuleName()
    {
        return 'admin.system-maintenance-logs';
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ Î™©Î°ù ÌéòÏù¥ÏßÄ (ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Íµ¨ÌòÑ)
     */
    protected function _index(Request $request): View
    {
        $query = SystemMaintenanceLog::with(['initiatedBy', 'completedBy']);

        // ÌïÑÌÑ∞ Ï†ÅÏö©
        $filters = $this->getFilterParameters($request);
        $query = $this->applyFilter($filters, $query, ['search']);

        // Ï†ïÎ†¨ Ï†ÅÏö©
        $sortField = $request->get('sort', 'created_at');
        $sortDirection = $request->get('direction', 'desc');
        $query->orderBy($sortField, $sortDirection);

        $maintenanceLogs = $query->paginate(20);

        // ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞
        $stats = $this->getMaintenanceStats();

        return view($this->indexPath, [
            'rows' => $maintenanceLogs,
            'maintenanceLogs' => $maintenanceLogs,
            'filters' => $filters,
            'sort' => $sortField,
            'dir' => $sortDirection,
            'route' => 'admin.system-maintenance-logs.',
            'stats' => $stats,
            'maintenanceTypes' => SystemMaintenanceLog::getMaintenanceTypes(),
            'statuses' => SystemMaintenanceLog::getStatuses(),
            'priorities' => SystemMaintenanceLog::getPriorities(),
            'errors' => new \Illuminate\Support\ViewErrorBag()
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÉùÏÑ± Ìèº (ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Íµ¨ÌòÑ)
     */
    protected function _create(Request $request): View
    {
        $admins = AdminUser::where('is_active', true)->get();

        return view($this->createPath, [
            'route' => 'admin.system-maintenance-logs.',
            'maintenanceTypes' => SystemMaintenanceLog::getMaintenanceTypes(),
            'statuses' => SystemMaintenanceLog::getStatuses(),
            'priorities' => SystemMaintenanceLog::getPriorities(),
            'admins' => $admins,
            'errors' => new \Illuminate\Support\ViewErrorBag()
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ Ï†ÄÏû• (ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Íµ¨ÌòÑ)
     */
    protected function _store(Request $request): \Illuminate\Http\JsonResponse
    {
        $request->validate([
            'maintenance_type' => 'required|string|in:' . implode(',', array_keys(SystemMaintenanceLog::getMaintenanceTypes())),
            'title' => 'required|string|max:255',
            'description' => 'required|string',
            'status' => 'required|string|in:' . implode(',', array_keys(SystemMaintenanceLog::getStatuses())),
            'scheduled_start' => 'nullable|date',
            'scheduled_end' => 'nullable|date|after:scheduled_start',
            'actual_start' => 'nullable|date',
            'actual_end' => 'nullable|date|after:actual_start',
            'duration_minutes' => 'nullable|integer|min:0',
            'notes' => 'nullable|string',
            'impact_assessment' => 'nullable|string',
            'initiated_by' => 'nullable|exists:admin_users,id',
            'completed_by' => 'nullable|exists:admin_users,id',
            'requires_downtime' => 'boolean',
            'priority' => 'required|string|in:' . implode(',', array_keys(SystemMaintenanceLog::getPriorities())),
            'affected_services' => 'nullable|json',
            'metadata' => 'nullable|json',
        ]);

        $log = SystemMaintenanceLog::create($request->all());

        // Activity Log Í∏∞Î°ù
        $this->logActivity('create', 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÉùÏÑ±', $log->id, $request->all());

        return response()->json([
            'success' => true,
            'message' => 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.',
            'log' => $log
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÉÅÏÑ∏ Ï°∞Ìöå (ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Íµ¨ÌòÑ)
     */
    protected function _show(Request $request, $id): View
    {
        $systemMaintenanceLog = SystemMaintenanceLog::with(['initiatedBy', 'completedBy'])->findOrFail($id);

        return view($this->showPath, [
            'route' => 'admin.system-maintenance-logs.',
            'maintenanceLog' => $systemMaintenanceLog,
            'maintenanceTypes' => SystemMaintenanceLog::getMaintenanceTypes(),
            'statuses' => SystemMaintenanceLog::getStatuses(),
            'priorities' => SystemMaintenanceLog::getPriorities(),
            'errors' => new \Illuminate\Support\ViewErrorBag()
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏàòÏ†ï Ìèº (ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Íµ¨ÌòÑ)
     */
    protected function _edit(Request $request, $id): View
    {
        $systemMaintenanceLog = SystemMaintenanceLog::findOrFail($id);
        $admins = AdminUser::where('is_active', true)->get();

        return view($this->editPath, [
            'route' => 'admin.system-maintenance-logs.',
            'maintenanceLog' => $systemMaintenanceLog,
            'maintenanceTypes' => SystemMaintenanceLog::getMaintenanceTypes(),
            'statuses' => SystemMaintenanceLog::getStatuses(),
            'priorities' => SystemMaintenanceLog::getPriorities(),
            'admins' => $admins,
            'errors' => new \Illuminate\Support\ViewErrorBag()
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ (ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Íµ¨ÌòÑ)
     */
    protected function _update(Request $request, $id): \Illuminate\Http\JsonResponse
    {
        $systemMaintenanceLog = SystemMaintenanceLog::findOrFail($id);
        
        // ÏàòÏ†ï Ï†Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Audit LogÏö©)
        $oldData = $systemMaintenanceLog->toArray();

        $request->validate([
            'maintenance_type' => 'required|string|in:' . implode(',', array_keys(SystemMaintenanceLog::getMaintenanceTypes())),
            'title' => 'required|string|max:255',
            'description' => 'required|string',
            'status' => 'required|string|in:' . implode(',', array_keys(SystemMaintenanceLog::getStatuses())),
            'scheduled_start' => 'nullable|date',
            'scheduled_end' => 'nullable|date|after:scheduled_start',
            'actual_start' => 'nullable|date',
            'actual_end' => 'nullable|date|after:actual_start',
            'duration_minutes' => 'nullable|integer|min:0',
            'notes' => 'nullable|string',
            'impact_assessment' => 'nullable|string',
            'initiated_by' => 'nullable|exists:admin_users,id',
            'completed_by' => 'nullable|exists:admin_users,id',
            'requires_downtime' => 'boolean',
            'priority' => 'required|string|in:' . implode(',', array_keys(SystemMaintenanceLog::getPriorities())),
            'affected_services' => 'nullable|json',
            'metadata' => 'nullable|json',
        ]);

        $systemMaintenanceLog->update($request->all());

        // Activity Log Í∏∞Î°ù
        $this->logActivity('update', 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏàòÏ†ï', $systemMaintenanceLog->id, $request->all());

        // Audit Log Í∏∞Î°ù
        $this->logAudit('update', $oldData, $request->all(), 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏàòÏ†ï', $systemMaintenanceLog->id);

        return response()->json([
            'success' => true,
            'message' => 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.',
            'log' => $systemMaintenanceLog
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÇ≠Ï†ú (ÌÖúÌîåÎ¶ø Î©îÏÜåÎìú Íµ¨ÌòÑ)
     */
    protected function _destroy(Request $request): \Illuminate\Http\JsonResponse
    {
        $id = $request->get('id') ?? $request->route('id');
        $systemMaintenanceLog = SystemMaintenanceLog::findOrFail($id);
        
        // ÏÇ≠Ï†ú Ï†Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Audit LogÏö©)
        $oldData = $systemMaintenanceLog->toArray();
        
        $systemMaintenanceLog->delete();

        // Activity Log Í∏∞Î°ù
        $this->logActivity('delete', 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÇ≠Ï†ú', $id, $oldData);

        // Audit Log Í∏∞Î°ù
        $this->logAudit('delete', $oldData, null, 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÇ≠Ï†ú', $id);

        return response()->json([
            'success' => true,
            'message' => 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.'
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω
     */
    public function updateStatus(Request $request, SystemMaintenanceLog $systemMaintenanceLog): \Illuminate\Http\JsonResponse
    {
        $request->validate([
            'status' => 'required|string|in:' . implode(',', array_keys(SystemMaintenanceLog::getStatuses())),
        ]);

        $oldStatus = $systemMaintenanceLog->status;
        $systemMaintenanceLog->update(['status' => $request->status]);

        // Activity Log Í∏∞Î°ù
        $this->logActivity('status_update', 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω', $systemMaintenanceLog->id, [
            'old_status' => $oldStatus,
            'new_status' => $request->status
        ]);

        $statusText = SystemMaintenanceLog::getStatuses()[$request->status];
        return response()->json([
            'success' => true,
            'message' => "Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏÉÅÌÉúÍ∞Ä '{$statusText}'Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§."
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÌÜµÍ≥Ñ
     */
    public function stats(): View
    {
        $stats = [
            'total' => SystemMaintenanceLog::count(),
            'scheduled' => SystemMaintenanceLog::where('status', 'scheduled')->count(),
            'in_progress' => SystemMaintenanceLog::where('status', 'in_progress')->count(),
            'completed' => SystemMaintenanceLog::where('status', 'completed')->count(),
            'failed' => SystemMaintenanceLog::where('status', 'failed')->count(),
            'avg_duration' => SystemMaintenanceLog::avg('duration_minutes'),
            'downtime_required' => SystemMaintenanceLog::where('requires_downtime', true)->count(),
            'recent_stats' => SystemMaintenanceLog::getRecentStats(30),
            'stats_by_type' => SystemMaintenanceLog::getStatsByType(),
            'stats_by_priority' => SystemMaintenanceLog::getStatsByPriority(),
        ];

        return view('jiny-admin::admin.system_maintenance_logs.stats', [
            'stats' => $stats,
            'maintenanceTypes' => SystemMaintenanceLog::getMaintenanceTypes(),
            'priorities' => SystemMaintenanceLog::getPriorities(),
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏùºÍ¥Ñ ÏÇ≠Ï†ú
     */
    public function bulkDelete(Request $request): \Illuminate\Http\JsonResponse
    {
        $request->validate([
            'selected_logs' => 'required|array',
            'selected_logs.*' => 'integer|exists:system_maintenance_logs,id',
        ]);

        $count = SystemMaintenanceLog::whereIn('id', $request->selected_logs)->delete();

        // Activity Log Í∏∞Î°ù
        $this->logActivity('bulk_delete', 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÏùºÍ¥Ñ ÏÇ≠Ï†ú', null, [
            'deleted_count' => $count,
            'deleted_ids' => $request->selected_logs
        ]);

        return response()->json([
            'success' => true,
            'message' => "{$count}Í∞úÏùò Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."
        ]);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
     */
    public function export(Request $request): RedirectResponse
    {
        $query = SystemMaintenanceLog::with(['initiatedBy', 'completedBy']);

        // ÌïÑÌÑ∞ Ï†ÅÏö©
        $query = $this->applyFilters($query, $request);

        $maintenanceLogs = $query->get();

        // CSV ÌååÏùº ÏÉùÏÑ±
        $filename = 'maintenance_logs_' . now()->format('Y-m-d_H-i-s') . '.csv';
        $filepath = storage_path('app/exports/' . $filename);

        if (!File::exists(dirname($filepath))) {
            File::makeDirectory(dirname($filepath), 0755, true);
        }

        $handle = fopen($filepath, 'w');
        
        // Ìó§Îçî ÏûëÏÑ±
        fputcsv($handle, [
            'ID', 'Ïú†ÏßÄÎ≥¥Ïàò ÌÉÄÏûÖ', 'Ï†úÎ™©', 'ÏÉÅÌÉú', 'Ïö∞ÏÑ†ÏàúÏúÑ', 'ÏòàÏ†ï ÏãúÏûë', 'ÏòàÏ†ï Ï¢ÖÎ£å',
            'Ïã§Ï†ú ÏãúÏûë', 'Ïã§Ï†ú Ï¢ÖÎ£å', 'ÏÜåÏöî ÏãúÍ∞Ñ(Î∂Ñ)', 'Îã§Ïö¥ÌÉÄÏûÑ ÌïÑÏöî', 'ÏãúÏûëÌïú Í¥ÄÎ¶¨Ïûê', 'ÏôÑÎ£åÌïú Í¥ÄÎ¶¨Ïûê', 'ÏÉùÏÑ±Ïùº'
        ]);

        // Îç∞Ïù¥ÌÑ∞ ÏûëÏÑ±
        foreach ($maintenanceLogs as $log) {
            fputcsv($handle, [
                $log->id,
                $log->maintenance_type,
                $log->title,
                $log->status,
                $log->priority,
                $log->scheduled_start?->format('Y-m-d H:i:s'),
                $log->scheduled_end?->format('Y-m-d H:i:s'),
                $log->actual_start?->format('Y-m-d H:i:s'),
                $log->actual_end?->format('Y-m-d H:i:s'),
                $log->duration_minutes,
                $log->requires_downtime ? 'Ïòà' : 'ÏïÑÎãàÏò§',
                $log->initiatedBy?->name,
                $log->completedBy?->name,
                $log->created_at->format('Y-m-d H:i:s')
            ]);
        }

        fclose($handle);

        // Activity Log Í∏∞Î°ù
        $this->logActivity('export', 'Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞', null, [
            'filename' => $filename,
            'exported_count' => $maintenanceLogs->count()
        ]);

        return response()->download($filepath, $filename)->deleteFileAfterSend();
    }

    /**
     * Í≤ÄÏÉâ ÌïÑÌÑ∞ Ï†ÅÏö©
     */
    private function applyFilters($query, Request $request)
    {
        // Ïú†ÏßÄÎ≥¥Ïàò ÌÉÄÏûÖ ÌïÑÌÑ∞
        if ($request->filled('filter_maintenance_type')) {
            $query->where('maintenance_type', $request->filter_maintenance_type);
        }

        // ÏÉÅÌÉú ÌïÑÌÑ∞
        if ($request->filled('filter_status')) {
            $query->where('status', $request->filter_status);
        }

        // Ïö∞ÏÑ†ÏàúÏúÑ ÌïÑÌÑ∞
        if ($request->filled('filter_priority')) {
            $query->where('priority', $request->filter_priority);
        }

        // Îã§Ïö¥ÌÉÄÏûÑ ÌïÑÏöî Ïó¨Î∂Ä ÌïÑÌÑ∞
        if ($request->filled('filter_requires_downtime')) {
            $query->where('requires_downtime', $request->filter_requires_downtime);
        }

        // ÎÇ†Ïßú Î≤îÏúÑ ÌïÑÌÑ∞
        if ($request->filled('filter_start_date')) {
            $query->where('created_at', '>=', $request->filter_start_date);
        }

        if ($request->filled('filter_end_date')) {
            $query->where('created_at', '<=', $request->filter_end_date . ' 23:59:59');
        }

        // Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞
        if ($request->filled('filter_search')) {
            $search = $request->filter_search;
            $query->where(function($q) use ($search) {
                $q->where('title', 'like', '%' . $search . '%')
                  ->orWhere('description', 'like', '%' . $search . '%')
                  ->orWhere('notes', 'like', '%' . $search . '%');
            });
        }

        return $query;
    }

    /**
     * Ï†ïÎ†¨ Ï†ÅÏö©
     */
    private function applySorting($query, Request $request)
    {
        $sortBy = $request->get('sort', 'created_at');
        $sortOrder = $request->get('direction', 'desc');

        // ÌóàÏö©Îêú Ï†ïÎ†¨ ÌïÑÎìúÎßå ÏÇ¨Ïö©
        $allowedSortFields = [
            'created_at', 'title', 'maintenance_type', 'status', 'priority',
            'scheduled_start', 'actual_start', 'duration_minutes'
        ];

        if (!in_array($sortBy, $allowedSortFields)) {
            $sortBy = 'created_at';
        }

        return $query->orderBy($sortBy, $sortOrder);
    }

    /**
     * Ïú†ÏßÄÎ≥¥Ïàò Î°úÍ∑∏ ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
     */
    private function getMaintenanceStats()
    {
        return [
            'total' => SystemMaintenanceLog::count(),
            'scheduled' => SystemMaintenanceLog::where('status', 'scheduled')->count(),
            'in_progress' => SystemMaintenanceLog::where('status', 'in_progress')->count(),
            'completed' => SystemMaintenanceLog::where('status', 'completed')->count(),
            'failed' => SystemMaintenanceLog::where('status', 'failed')->count(),
            'avg_duration' => SystemMaintenanceLog::whereNotNull('duration_minutes')->avg('duration_minutes'),
            'downtime_required' => SystemMaintenanceLog::where('requires_downtime', true)->count(),
            'recent_stats' => SystemMaintenanceLog::getRecentStats(30),
            'stats_by_type' => SystemMaintenanceLog::getStatsByType(),
            'stats_by_priority' => SystemMaintenanceLog::getStatsByPriority(),
        ];
    }
}
